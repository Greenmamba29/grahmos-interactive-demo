name: PRISM Quality Gates

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quality Gate 1: Code Quality and Style
  code-quality:
    name: Code Quality & Style
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Check code formatting
        run: cargo fmt --all -- --check
        
      - name: Run Clippy lints
        run: cargo clippy --all-targets --all-features -- -D warnings
        
      - name: Check for security vulnerabilities
        run: |
          cargo install cargo-audit
          cargo audit
          
      - name: Check dependencies
        run: |
          cargo install cargo-outdated
          cargo outdated --exit-code 1

  # Quality Gate 2: Test Coverage
  test-coverage:
    name: Test Coverage (>90% Target)
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Install coverage tools
        run: |
          cargo install cargo-tarpaulin
          
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Run unit tests with coverage
        run: |
          cargo tarpaulin --workspace \
            --out xml \
            --output-dir coverage \
            --exclude-files "*/tests/*" "*/benches/*" \
            --timeout 300 \
            --fail-under 90
            
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: coverage/cobertura.xml
          fail_ci_if_error: true
          
      - name: Coverage Gate Check
        run: |
          COVERAGE=$(cargo tarpaulin --workspace --print summary --timeout 300 | grep "Coverage:" | awk '{print $2}' | sed 's/%//')
          echo "Test coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 90.0" | bc -l) )); then
            echo "‚ùå Coverage ${COVERAGE}% is below 90% requirement"
            exit 1
          else
            echo "‚úÖ Coverage ${COVERAGE}% meets 90% requirement"
          fi

  # Quality Gate 3: Unit Tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        rust: [stable, beta]
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Run unit tests
        run: |
          cd tests/unit
          cargo test --verbose --release
          
      - name: Run CRDT property tests
        run: |
          cd tests/unit
          cargo test --verbose --release crdt_tests
          
      - name: Verify CRDT laws
        run: |
          cd tests/unit
          cargo test --verbose --release test_all_crdt_laws_comprehensive

  # Quality Gate 4: Performance Benchmarks
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-cargo-bench-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Run storage benchmarks
        run: |
          cd benchmarks
          cargo bench storage_benchmarks -- --output-format json | tee storage_results.json
          
      - name: Validate storage performance
        run: |
          python3 scripts/validate_benchmarks.py storage_results.json \
            --min-throughput 100 \
            --max-memory 512 \
            --min-dedup-ratio 0.7
            
      - name: Run consensus benchmarks
        run: |
          cd benchmarks
          cargo bench consensus_benchmarks -- --output-format json | tee consensus_results.json
          
      - name: Validate consensus performance
        run: |
          python3 scripts/validate_benchmarks.py consensus_results.json \
            --max-latency 200 \
            --min-throughput 1000
            
      - name: Store benchmark results
        uses: benchmark-action/github-action-benchmark@v1
        with:
          tool: 'cargo'
          output-file-path: benchmarks/*.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true

  # Quality Gate 5: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    services:
      # Add any required services for integration testing
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-integration-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Setup test environment
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io
          
      - name: Run integration tests
        run: |
          cd tests/integration
          cargo test --verbose --release --test-threads=1
          
      - name: Test consensus integration
        run: |
          cd tests/integration
          cargo test --verbose --release consensus_integration_tests
          
      - name: Test storage integration
        run: |
          cd tests/integration
          cargo test --verbose --release storage_integration_tests

  # Quality Gate 6: Chaos Engineering (Optional - only on main branch)
  chaos-tests:
    name: Chaos Engineering Tests
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target/
          key: ${{ runner.os }}-chaos-${{ hashFiles('**/Cargo.lock') }}
          
      - name: Install chaos engineering tools
        run: |
          # Install chaos mesh or similar tools
          curl -sSL https://mirrors.chaos-mesh.org/v2.4.3/install.sh | bash
          
      - name: Run network partition tests
        run: |
          cd tests/chaos
          cargo test --verbose --release network_partition_resilience
          
      - name: Run node failure tests
        run: |
          cd tests/chaos
          cargo test --verbose --release node_failure_recovery
          
      - name: Generate chaos test report
        run: |
          cd tests/chaos
          cargo test --verbose --release -- --report-time | tee chaos_report.txt

  # Quality Gate 7: Security Scanning
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Security audit
        run: |
          cargo install cargo-audit
          cargo audit --deny warnings
          
      - name: Dependency vulnerability scan
        uses: rustsec/audit-check@v1.4.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: SAST scan with Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  # Quality Gate 8: Documentation
  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        
      - name: Check documentation
        run: |
          cargo doc --workspace --no-deps --document-private-items
          
      - name: Validate README
        run: |
          if [ ! -f README.md ]; then
            echo "‚ùå README.md is required"
            exit 1
          fi
          
      - name: Check for missing docs
        run: |
          cargo doc --workspace 2>&1 | grep -i "missing documentation" && exit 1 || exit 0
          
      - name: Validate API documentation coverage
        run: |
          # Custom script to check documentation coverage
          python3 scripts/check_doc_coverage.py --min-coverage 80

  # Final Quality Gate: Deploy Gate
  deploy-gate:
    name: Deployment Quality Gate
    runs-on: ubuntu-latest
    needs: [test-coverage, unit-tests, performance-benchmarks, integration-tests, security-scan, documentation]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Quality Gate Summary
        run: |
          echo "üéâ All quality gates passed!"
          echo "‚úÖ Code quality and style"
          echo "‚úÖ Test coverage >90%"
          echo "‚úÖ Unit tests passing"
          echo "‚úÖ Performance benchmarks met"
          echo "‚úÖ Integration tests passing" 
          echo "‚úÖ Security scans clean"
          echo "‚úÖ Documentation complete"
          echo ""
          echo "üöÄ Ready for deployment"
          
      - name: Create deployment artifact
        run: |
          cargo build --release --workspace
          tar -czf prism-release.tar.gz target/release/
          
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: prism-release
          path: prism-release.tar.gz
          retention-days: 30

  # Notification on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test-coverage, unit-tests, performance-benchmarks, integration-tests, security-scan, documentation]
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "‚ùå Quality gates failed for commit ${{ github.sha }}"
          echo "Check the failed jobs and fix issues before merging"
          # Add webhook notification or Slack integration here