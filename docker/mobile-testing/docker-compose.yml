version: '3.8'

services:
  # iOS Simulator Environment
  ios-simulator:
    image: sickcodes/docker-osx:ventura
    platform: linux/amd64
    environment:
      - DISPLAY=${DISPLAY:-:99}
      - XCODE_VERSION=14.3
      - SIMULATOR_DEVICE=iPhone 14 Pro
      - ENABLE_P2P_MESH=true
    volumes:
      - ios_simulator_data:/System/Applications/Xcode.app
      - ../tests/mobile:/app/tests:ro
    networks:
      - mobile_mesh_network
    ports:
      - "5900:5900"  # VNC access
      - "8080:8080"  # Test server
    mem_limit: 8g
    cpus: 4
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # Android Emulator Environment  
  android-emulator:
    image: budtmo/docker-android:emulator_11.0
    platform: linux/amd64
    environment:
      - DEVICE=Samsung Galaxy S21
      - ANDROID_VERSION=11.0
      - API_LEVEL=30
      - TARGET=google_apis_playstore
      - ENABLE_P2P_MESH=true
    volumes:
      - android_emulator_data:/root/.android
      - ../tests/mobile:/app/tests:ro
    networks:
      - mobile_mesh_network
    ports:
      - "6080:6080"  # VNC access
      - "5554:5554"  # ADB
      - "5555:5555"  # ADB
      - "8081:8081"  # Test server
    devices:
      - "/dev/kvm:/dev/kvm"
    mem_limit: 6g
    cpus: 3
    healthcheck:
      test: ["CMD", "adb", "shell", "echo", "ok"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  # Network Simulation Controller
  network-simulator:
    image: alpine:3.18
    platform: linux/amd64
    environment:
      - SIMULATION_MODE=p2p_mesh
      - LATENCY_PROFILES=wifi,4g,3g,edge,offline
      - PEER_DISCOVERY_ENABLED=true
    volumes:
      - ./network-configs:/etc/network-sim:ro
      - ../tests/mobile:/app/tests:ro
    networks:
      - mobile_mesh_network
    ports:
      - "9090:9090"  # Control API
    command: |
      sh -c "
        apk add --no-cache curl jq python3 py3-pip tcpdump &&
        pip3 install flask requests &&
        python3 /app/tests/network_simulator.py
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/status"]
      interval: 15s
      timeout: 5s
      retries: 3
      
  # P2P Mesh Coordinator
  p2p-coordinator:
    image: rust:1.75-alpine
    platform: linux/amd64
    working_dir: /app
    environment:
      - RUST_LOG=debug
      - MESH_DISCOVERY_PORT=7777
      - MAX_PEERS=10
      - HEARTBEAT_INTERVAL=5s
    volumes:
      - ../:/app:ro
      - p2p_coordinator_data:/app/target
    networks:
      - mobile_mesh_network
    ports:
      - "7777:7777"  # P2P discovery
      - "8888:8888"  # Coordinator API
    command: |
      sh -c "
        apk add --no-cache build-base openssl-dev &&
        cd tests/mobile &&
        cargo build --release --bin p2p_coordinator &&
        ./target/release/p2p_coordinator
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/peers"]
      interval: 20s
      timeout: 10s
      retries: 3
      
  # Test Results Collector
  test-collector:
    image: node:18-alpine
    platform: linux/amd64
    working_dir: /app
    environment:
      - NODE_ENV=testing
      - COLLECT_REAL_TIME=true
      - DASHBOARD_ENDPOINT=http://localhost:3000/api/results
    volumes:
      - ./test-collector:/app:ro
      - test_results:/app/results
    networks:
      - mobile_mesh_network  
    ports:
      - "3001:3001"  # Results API
    command: |
      sh -c "
        npm install express axios ws &&
        node test-collector.js
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  mobile_mesh_network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: 1500

volumes:
  ios_simulator_data:
    driver: local
  android_emulator_data:
    driver: local
  p2p_coordinator_data:
    driver: local
  test_results:
    driver: local
